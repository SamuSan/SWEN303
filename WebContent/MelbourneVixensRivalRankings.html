<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>

    <link rel="stylesheet" href="styles/bootstrap/dist/css/bootstrap.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/d3.slider.css">


</head>

<body>


<script type="text/javascript" src="d3/d3.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="js/numeral/numeral.js"></script>
<script type="text/javascript" src="d3Functions.js"></script>
<script type="text/javascript" src="js/d3slider/d3.slider.js"></script>
<div class="sexyMainDiv">
<select id="teamSelector" class="dropdown-menu-left">
    <option> Adelaide Thunderbirds</option>
    <option> Melbourne Vixens</option>
    <option> Central Pulse</option>
    <option> Queensland Firebirds</option>
    <option> Waikato Bay of Plenty Magic</option>
    <option> Southern Steel</option>
    <option> New South Wales Swifts</option>
    <option> Northern Mystics</option>
    <option> West Coast Fever</option>
    <option> Canterbury Tactix</option>
</select>

<table>
<tr>
<td></td>
<td id="barSvgCell">
<script type="text/javascript">

var width = 1200;
var height = 700;
var pbsWidth = 300;
var pbsHeight = 375;
var pbsBarHeight = 20;
var marg = 50;
function stripQuotes(str) {
    var s = str.replace(/\"/g, '');
    return s;
}
var teamNames = [
    "Adelaide Thunderbirds",
    "Central Pulse" ,
    "Canterbury Tactix",
    "Melbourne Vixens",
    "New South Wales Swifts",
    "Northern Mystics",
    "Queensland Firebirds",
    "Southern Steel",
    "Waikato Bay of Plenty Magic",
    "West Coast Fever"
];
document.getElementById("teamSelector").selectedIndex=1;
var currTeam = stripQuotes(document.getElementById("teamSelector").options[1].value);
console.log("Initialised team = " + currTeam);
var offSet = 30;
var barWidth = 80;
var factor = 20;
var teamColors = [
    {
        AdelaideThunderbirdsRect: [
            {'fill1': '#FF1493' /* Pink */, 'fill2': '#FFFFF1'/* White */}
        ]

    },
    {
        CentralPulseRect: [
            {
                "fill1": "#FFFF00", /* Yellow */
                "fill2": "#1560BD" /* Blue */
            }
        ]
    }
    ,
    {                            /*CANTERBURY TACTIX*/
        CanterburyTactixRect: [
            {
                "fill1": '#FF0000', /* Red */
                "fill2": '#000000'/* Black */
            }
        ]
    },
    {                            /* MELB VIX*/
        MelbourneVixensRect: [
            {
                "fill1": '#191970', /* Dark Blue */
                "fill2": '#008080'/* Green */
            }
        ]
    },
    {                            /*NSW SWIFTS*/
        NewSouthWalesSwiftsRect: [
            {
                "fill1": '#FF0000', /*Red*/
                "fill2": '#6495ED'/*Light Blue*/
            }
        ]
    },
    {                            /*NORTHERN MYSTICS*/
        NorthernMysticsRect: [
            {
                "fill1": '#0000FF', /* Royal Blue */
                "fill2": '#FF0000'/* Red */
            }
        ]
    },
    {                            /*QUEENSLAND FIREBIRDS*/
        QueenslandFirebirdsRect: [
            {
                "fill1": '#800080', /* Purple */
                "fill2": '#FFA500'/* Gold */
            }
        ]
    },
    {                            /*SOUTHERN STEEL*/
        SouthernSteelRect: [
            {
                "fill1": '#00B7EB', /* Light Blue*/
                "fill2": '#000000'/*Black*/
            }
        ]
    },
    {                            /*WAIKATO BAY OF PLENTY MAGIC*/
        WaikatoBayofPlentyMagicRect: [
            {
                "fill1": '#000000', /* Black */
                "fill2": '#FF4500'/* Orange */
            }
        ]
    },
    {                            /*WESTCOST FEVER*/
        WestCoastFeverRect: [
            {
                "fill1": '#000000', /* Black */
                "fill2": '#32CD32'/* Bright Ugly Green*/
            }
        ]}
];
var svg = d3.select("#barSvgCell")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("transform", "translate(" + (width / 8) + ",50)");
var rivContainer = svg.append("g");
var force = d3.layout.force()
        .charge(-500)
        .linkDistance(500)
        .size([width, height]);
var color = d3.scale.category20();

defs = svg.append("svg:defs");
defs.append('svg:pattern')
        .attr('id', 'AdelaideThunderbirdsImage')
        .attr('patternUnits', 'objectBoundingBox')
        .attr('width', 1)
        .attr('height', 1)
        .append('svg:image')
        .attr('xlink:href', 'http://i59.tinypic.com/e9xjk2.jpg')
        .attr('x', 0)
        .attr('y', 0)
        .attr('width', 200)
        .attr('height', 200);

var x = d3.scale.linear().domain([0, 100])
        .range([0, width - 300]);
var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
var y = d3.scale.linear().domain([1, 9])
        .range([height, 0]);
var yAxis = d3.svg.axis()
//        .scale(y)
        .orient("left");
//MAIN BEGIN
var winsVsTeam = svg.append("g");
var lossVsTeam = svg.append("g");
d3.json("data/allSeasons.json", function (data) {


    var rivalsGraphData = getRivals(data);
//BEGIN MAIN
//    x.domain(rivalsGraphData.map(function (d) {
//        return d.value;
//    }));

    svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(" + marg + "," + (height - 110  ) + ")")
            .call(xAxis)
            .selectAll("text")
            .attr("font-size", "20px")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", function (d) {
                return "rotate(-65)"
            });


    var pbsScale = d3.scale.linear()
            .domain([0, 100])
            .range([0, width-300]);
    var pbsHScale = d3.scale.linear()
            .domain([0, rivalsGraphData.length])
            .range([100, height - 100]);

    var pbsBack = svg.append("g");

    pbsBack.append("rect")
            .attr("width", width)
            .attr("height", height)
            .attr("id", "pbsBack")
            .attr("x", 0)
            .attr("y", 0)
            .attr("class", "pointsBySeason");

    pbsBack.append("text").attr("id","headerText").text(currTeam + " Rival Rankings ").attr("x", width / 4).attr("y", 0).attr("font-size", "20px");


//POINTS BY SESSON
    winsVsTeam.selectAll("rect")
            .data(rivalsGraphData)
            .enter()
            .append("rect")
            .on("click", function (d) {
                d3.select(this).attr("title", function (d) {
                    return d.value;
                });
            })
            .attr("x", marg)
            .attr("y", function (d, i) {
                return pbsHScale(i);
            })
            .attr("id", function (d) {
                return d.target;
            })
            .attr("height", pbsBarHeight)
            .attr("width", function (d) {
                return pbsScale(d.value);
            })
            .attr("class", function (d) {
                var name = stripSpaces(d.source, "Circle");

                return name;
            })
            .attr("opactiy", .4)
            .attr("stroke-width", "1px")
            .attr("stroke", "white");

    lossVsTeam.selectAll("rect")
            .data(rivalsGraphData)
            .enter()
            .append("rect")
            .on("click", function (d) {
                d3.select(this).attr("title", function (d) {
                    return d.value;
                });
            })
            .attr("x", function (d, i) {
                return  marg + (pbsScale(d.value));

            })
            .attr("y", function (d, i) {
                return pbsHScale(i);
            })
            .attr("id", function (d) {
                return d.target;
            })
            .attr("height", pbsBarHeight)
            .attr("width", function (d) {
                return pbsScale(100 - (d.value));
            })
            .attr("class", function (d) {
                var name = stripSpaces(d.target, "Circle");

                return name;
            })
            .attr("opactiy", .4)
            .attr("stroke-width", "1px")
            .attr("stroke", "white");

    winsVsTeam.selectAll("text")
            .data(rivalsGraphData)
            .enter()
            .append("text")
            .text(function (d,i) {

                var tex ="#"+(i+1)+" "+ currTeam +" "+ numeral(d.value/100).format('0.%') +" vs "+ d.target+" "+numeral((100-d.value)/100).format('0.%');
                return tex;
            })
            .attr("x", marg + 5)
            .attr("y", function (d, i) {
                return pbsHScale(i)-5;
            })
            .attr("fill", "black")
            .attr("font-size", "12px");




    //END MAIN


    //Selector
    d3.select("#teamSelector").on("change", function () {
        console.log("DOINGFUCKING CHANGE BULLSHIT");
        var sel = document.getElementById("teamSelector");
        var name = stripQuotes(sel.options[sel.selectedIndex].value);
        currTeam = name;
        change();
        console.log(currTeam);
    });
    ///Selecter
//CHANGE
    function change(){

        var newRivalsGraphData = getRivals(data);
        pbsBack.select("#headerText").text(currTeam + " Rival Rankings ");

        winsVsTeam.selectAll("rect")
                .data(newRivalsGraphData)
                .transition()
                .attr("x", marg)
                .attr("y", function (d, i) {
                    return pbsHScale(i);
                })
                .attr("id", function (d) {
                    return d.target;
                })
                .attr("height", pbsBarHeight)
                .attr("width", function (d) {
                    return pbsScale(d.value);
                })
                .attr("class", function (d) {
                    var name = stripSpaces(d.source, "Circle");

                    return name;
                })
                .attr("opactiy", .4)
                .attr("stroke-width", "1px")
                .attr("stroke", "white");
//
        lossVsTeam.selectAll("rect")
                .data(newRivalsGraphData)
                .transition()
                .attr("x", function (d, i) {
                    return  marg + (pbsScale(d.value));

                })
                .attr("y", function (d, i) {
                    return pbsHScale(i);
                })
                .attr("id", function (d) {
                    return d.target;
                })
                .attr("height", pbsBarHeight)
                .attr("width", function (d) {
                    return pbsScale(100 - (d.value));
                })
                .attr("class", function (d) {
                    var name = stripSpaces(d.target, "Circle");

                    return name;
                })
                .attr("opactiy", .4)
                .attr("stroke-width", "1px")
                .attr("stroke", "white");
//
        winsVsTeam.selectAll("text")
                .data(newRivalsGraphData)
                .text(function (d,i) {

                    var tex = "#"+(i+1)+" "+currTeam +" "+ numeral(d.value/100).format('0.%') +" vs "+ d.target+" "+numeral((100-d.value)/100).format('0.%');
                    return tex;
                })
                .attr("x", marg + 5)
                .attr("y", function (d, i) {
                    return pbsHScale(i)-5;
                })
                .attr("fill", "black")
                .attr("font-size", "12px");





    }




    //END CHANGE

    function getRivals(data) {

        var graph = [];


        var linkIdx = 0;


        for (var team2 in teamNames) {
            if (currTeam !== teamNames[team2]) {
                var year = +2008;
                var currTeamWinCount = 0;
                var lossCount = 0;

                for (var i = 5; i >= 0; i--) {
                    var season = data["seasons"][0][year];
                    for (var x = season.length - 1; x >= 0; x--) {
                        if (season[x].winner === currTeam && season[x].loser === teamNames[team2]) {
                            currTeamWinCount += 1;
                        }
                        else if (season[x].winner === teamNames[team2] && season[x].loser === currTeam) {

                            lossCount += 1;
                        }
                    }
                    year += 1;
                }

            }
//console.log(currTeamWinCount /(lossCount+currTeamWinCount) );
            var perc =((currTeamWinCount / (lossCount + currTeamWinCount)) * 100);
            if (currTeam !== teamNames[team2] && (perc > 25 && perc <75) ) {
                console.log((currTeamWinCount / (lossCount + currTeamWinCount)) * 100);
                graph.push({"source": currTeam, "target": teamNames[team2], "value": ((currTeamWinCount / (lossCount + currTeamWinCount)) * 100 )});
            }
            currTeamWinCount = 0;
            lossCount = 0;

        }

        graph = graph.sort(function (a, b) {
            return a.value > b.value;
        })
        return graph;

    }
});
//END MAIN

function getIndex(name) {
    return teamNames.indexOf(name);
}


</script>
</td>
<td>
    <div id="gamesDiv">
    </div>
</td>
</tr>
</table>
</div>
</body>
</html>